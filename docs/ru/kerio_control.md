# Настройка обновлений Kerio Control через локальное зеркало

## 1. Настройка сервера Kerio Connect

Для правильной работы зеркала обновлений необходимо выполнить несколько шагов на сервере Kerio Connect.

* ### Добавление правил в iptables

Для перенаправления трафика в Docker-контейнер с локальным зеркалом обновлений необходимо добавить следующие правила в
iptables:

1. Перенаправление трафика 443 порта на адрес зеркала:
   ```bash
   sudo iptables -t nat -A PREROUTING -p tcp -d <IP_KERIO_CONTROL> --dport 443 -j DNAT --to-destination 172.222.0.10:443
   ```

2. Разрешение трафика от сервера Kerio Control до зеркала:
    ```bash
   sudo iptables -A FORWARD -p tcp -s <IP_KERIO_CONTROL> -d 172.222.0.10 --dport 443 -j ACCEPT
   ```

> Такие пары правил нужно добавлять для каждого сервера Kerio Control, который будет использовать локальное зеркало
> обновлений.

* ### Сохранение правил после перезагрузки

Чтобы добавленные правила iptables не исчезли после перезагрузки, установите и настройте пакет iptables-persistent:

- Установка пакета:
   ```bash
   sudo apt install iptables-persistent -y
   ```

- Если пакет уже установлен, обновите текущие правила:
    ```bash
   sudo dpkg-reconfigure iptables-persistent
   ```

## 2. Настройка сервера Kerio Control

Настроим сервер Kerio Control для использования локального зеркала обновлений.

* ### Добавление хостов обновлений в локальный DNS

Для правильной маршрутизации запросов на обновления добавьте следующие записи в конфигурацию локального DNS (
```Конфигурация → DNS → Локальный поиск DNS```):

| IP-адрес     | Имена хостов            | Описание             |
|--------------|-------------------------|----------------------|
| 172.222.0.10 | bda-update.kerio.com    | kerio_updates_mirror |
| 172.222.0.10 | bdupdate.kerio.com      | kerio_updates_mirror |
| 172.222.0.10 | ids-update.kerio.com    | kerio_updates_mirror |
| 172.222.0.10 | prod-update.kerio.com   | kerio_updates_mirror |
| 172.222.0.10 | update.kerio.com        | kerio_updates_mirror |
| 172.222.0.10 | wf-activation.kerio.com | kerio_updates_mirror |

* ### Добавление статического маршрута

Если сервера Kerio Connect и Kerio Control находится в одной сети, добавьте статический маршрут в таблицу
маршрутизации (```Конфигурация → Таблица маршрутизации → Статические маршруты```):

| Параметр     | Значение                           |
|--------------|------------------------------------|
| Имя маршрута | kerio_updates_mirror               |
| Сеть         | 172.222.0.10                       |
| Маска        | 255.255.255.255                    |
| Интерфейс    | <выбрать интерфейс локальной сети> |
| Шлюз         | <IP_адрес_Kerio_Connect>           |
| Метрика      | 1                                  |

* ### Добавление пользовательского маршрута удаленной сети

Если сервера Kerio Connect и Kerio Control находится в разных сетях, и эти сети связаны с помощью Kerio VPN, добавьте
дополнительный пользовательский маршрут (
```Конфигурация → Интерфейсы → Kerio VPN туннель до сети с Kerio Connect → Удаленные сети → Использовать пользовательский маршруты```):

| Параметр | Значение             |
|----------|----------------------|
| Сеть     | 172.222.0.10         |
| Маска    | 255.255.255.255      |
| Описание | kerio_updates_mirror |
